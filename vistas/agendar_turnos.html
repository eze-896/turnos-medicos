<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Turnos - Sistema Médico</title>
    <link rel="stylesheet" href="estilos/registro_medico.css">
    <style>
        .contenedor-agendar {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .info-medico {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .checkbox-horas {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .checkbox-horas label {
            display: flex;
            align-items: center;
            font-size: 13px;
            padding: 5px;
        }
        .checkbox-horas label:hover {
            background: #f0f0f0;
        }
        .btn-crear {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .btn-crear:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-cancelar {
            background: #6c757d;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .error { color: #e74c3c; }
        .success { color: #27ae60; }
        .warning { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        #fecha { 
            margin-bottom: 10px;
            padding: 8px;
            font-size: 16px;
        }
        #mensaje-respuesta { 
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .info-destacada {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header>
        <h1>Agendar Turnos para Médico</h1>
    </header>

    <div class="contenedor-agendar">
        <div class="info-medico">
            <h2 id="medico-info">Cargando...</h2>
        </div>

        <div class="info-destacada">
            <strong>⚠️ IMPORTANTE:</strong> Los turnos se crearán para <strong>TODO EL MES</strong> en los días laborables del médico, con intervalos de <strong>30 minutos</strong> entre las 8:00 y 21:00.
        </div>

        <label for="fecha"><strong>Seleccionar Fecha de Referencia (para determinar el mes):</strong></label>
        <input type="date" id="fecha" required>
        <div id="validacion-fecha" class="error" style="display: none;"></div>

        <div id="contenedor-horas" style="display: none;">
            <h3>Seleccionar Horarios (slots de 30 minutos: 08:00 - 21:00)</h3>
            <div class="checkbox-horas" id="lista-horas">
                <!-- Checkboxes generados dinámicamente -->
            </div>
            
            <div style="margin: 15px 0;">
                <label>
                    <input type="checkbox" id="seleccionar-todos"> 
                    <strong>Seleccionar todos los horarios</strong>
                </label>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <button type="button" id="btn-crear-turnos" class="btn-crear" disabled>Crear Turnos para Todo el Mes</button>
            <button type="button" class="btn-cancelar" onclick="window.location.href='administracion.html'">Cancelar</button>
        </div>

        <div id="mensaje-respuesta"></div>
    </div>

<script>
    $(document).ready(function() {
        // Cargar info del médico de sessionStorage
        const idMedico = sessionStorage.getItem('medico_id');
        const nombreMedico = sessionStorage.getItem('medico_nombre');
        const especialidades = sessionStorage.getItem('medico_especialidades');
        const diasJson = sessionStorage.getItem('medico_dias');
        
        console.log('Datos de sessionStorage:', { idMedico, nombreMedico, especialidades, diasJson });
        
        if (!idMedico || !nombreMedico) {
            alert('Error: No se encontró el médico. Redirigiendo...');
            window.location.href = 'administracion.html';
            return;
        }
        
        // Parsear días
        let dias = [];
        if (diasJson) {
            try {
                dias = JSON.parse(diasJson);
                console.log('Días parseados exitosamente:', dias);
            } catch (e) {
                console.error('Error parseando días JSON:', e);
                alert('Error en datos de días. Usando sin validación de días.');
                dias = [];
            }
        } else {
            console.warn('No hay días en sessionStorage. Validación de días deshabilitada.');
            dias = [];
        }
        
        // Mostrar info del médico
        const diasNombres = dias.map(d => d.nombre).join(', ') || 'Ninguno';
        $('#medico-info').html(`
            <strong>Médico:</strong> ${nombreMedico}<br>
            <strong>Especialidades:</strong> ${especialidades}<br>
            <strong>Días laborables:</strong> ${diasNombres}
        `);
        
        // Configurar fecha mínima
        const hoy = new Date().toISOString().split('T')[0];
        $('#fecha').attr('min', hoy);
        
        // Generar horarios de 30 minutos (08:00 a 21:00)
        function generarHorarios() {
            const horarios = [];
            for (let hora = 8; hora <= 20; hora++) {
                for (let minuto = 0; minuto < 60; minuto += 30) {
                    const horaStr = hora.toString().padStart(2, '0');
                    const minutoStr = minuto.toString().padStart(2, '0');
                    horarios.push(`${horaStr}:${minutoStr}`);
                }
            }
            // Agregar 21:00
            horarios.push('21:00');
            return horarios;
        }
        
        const horarios = generarHorarios();
        const contenedorHoras = $('#lista-horas');
        
        horarios.forEach(function(hora) {
            contenedorHoras.append(`
                <label>
                    <input type="checkbox" name="horas[]" value="${hora}"> ${hora}
                </label>
            `);
        });
        
        // Selector/deselector de todos los horarios
        $('#seleccionar-todos').on('change', function() {
            $('input[name="horas[]"]').prop('checked', this.checked);
            actualizarBotonCrear();
        });
        
        // Actualizar estado del botón crear
        function actualizarBotonCrear() {
            const horasSeleccionadas = $('input[name="horas[]"]:checked').length;
            $('#btn-crear-turnos').prop('disabled', horasSeleccionadas === 0);
        }
        
        $('input[name="horas[]"]').on('change', actualizarBotonCrear);
        
        // Si no hay días, advertir y deshabilitar validación
        if (dias.length === 0) {
            $('#validacion-fecha').html('<p class="warning">Advertencia: No se cargaron días laborables. Se crearán turnos para todos los días del mes.</p>').show();
            $('#contenedor-horas').show();
        }
        
        // Evento: Al cambiar fecha, validar
        $('#fecha').on('change', function() {
            const fecha = $(this).val();
            const validacionDiv = $('#validacion-fecha');
            const contenedorHorasDiv = $('#contenedor-horas');
            const btnCrear = $('#btn-crear-turnos');
            
            if (!fecha) {
                contenedorHorasDiv.hide();
                btnCrear.prop('disabled', true);
                return;
            }
            
            // Validar fecha futura
            if (fecha < hoy) {
                validacionDiv.text('La fecha debe ser futura.').show();
                contenedorHorasDiv.hide();
                btnCrear.prop('disabled', true);
                return;
            }
            
            // Si no hay días, mostrar todo sin validación
            if (dias.length === 0) {
                validacionDiv.hide();
                contenedorHorasDiv.show();
                $('input[name="horas[]"]').prop('checked', false);
                $('#seleccionar-todos').prop('checked', false);
                console.log('Sin días: Mostrando horas sin validación.');
                return;
            }
            
            // Calcular día de la semana
            const fechaLocal = new Date(fecha + 'T00:00:00');
            let diaSemana = fechaLocal.getDay();
            if (diaSemana === 0) diaSemana = 7;
            
            const diaLaborable = dias.some(d => parseInt(d.id) === diaSemana);
            console.log('¿Es día laborable?', diaLaborable);
            
            if (!diaLaborable) {
                const diaSeleccionado = fechaLocal.toLocaleDateString('es-ES', {weekday: 'long'});
                const diasValidos = dias.map(d => d.nombre).join(', ');
                validacionDiv.html(`El médico no trabaja los ${diaSeleccionado}. Días válidos: ${diasValidos}.`).show();
                contenedorHorasDiv.hide();
                btnCrear.prop('disabled', true);
                return;
            }
            
            // Válido: Mostrar horas
            validacionDiv.hide();
            contenedorHorasDiv.show();
            $('input[name="horas[]"]').prop('checked', false);
            $('#seleccionar-todos').prop('checked', false);
            console.log('Fecha válida, mostrando horas.');
        });
        
        // Evento: Crear turnos para todo el mes
        $('#btn-crear-turnos').on('click', function() {
            const fecha = $('#fecha').val();
            const horasSeleccionadas = $('input[name="horas[]"]:checked').map(function() { 
                return $(this).val(); 
            }).get();
            const mensajeDiv = $('#mensaje-respuesta');
            
            if (horasSeleccionadas.length === 0) {
                alert('Selecciona al menos un horario.');
                return;
            }
            
            if (!confirm(`¿Crear turnos para TODO EL MES?\n\nMédico: ${nombreMedico}\nHorarios: ${horasSeleccionadas.join(', ')}\n\nEsto creará múltiples turnos automáticamente.`)) {
                return;
            }
            
            console.log('Creando turnos para mes completo - Fecha base:', fecha, 'Horas:', horasSeleccionadas, 'Médico ID:', idMedico);
            
            // Mostrar mensaje de procesamiento
            mensajeDiv.html('<p class="warning">Procesando... Esto puede tomar unos segundos.</p>');
            $('#btn-crear-turnos').prop('disabled', true);
            
            // Enviar AJAX
            $.ajax({
                url: '../controles/crear_turnos.php',
                type: 'POST',
                data: {
                    id_medico: idMedico,
                    fecha: fecha,
                    horas: horasSeleccionadas
                },
                dataType: 'json',
                success: function(respuesta) {
                    console.log('Respuesta de crear_turnos.php:', respuesta);
                    
                    if (respuesta.exito) {
                        mensajeDiv.html(`<p class="success">✅ ${respuesta.mensaje}</p>`);
                        alert(`¡Éxito! ${respuesta.mensaje}\n\nRedirigiendo a administración...`);
                        sessionStorage.clear();
                        setTimeout(() => {
                            window.location.href = 'administracion.html';
                        }, 2000);
                    } else {
                        mensajeDiv.html(`<p class="error">❌ ${respuesta.mensaje}</p>`);
                        $('#btn-crear-turnos').prop('disabled', false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error AJAX crear turnos:', error, 'Status:', status, 'Response:', xhr.responseText);
                    const errorMsg = xhr.responseJSON ? (xhr.responseJSON.mensaje || error) : error;
                    mensajeDiv.html(`<p class="error">❌ Error al crear turnos: ${errorMsg}</p>`);
                    $('#btn-crear-turnos').prop('disabled', false);
                }
            });
        });
    });
</script>
</body>
</html>